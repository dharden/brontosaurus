module.exports = function () {
    this.World = require('../support/world.js').World;

    this.When('I run spooky', function (callback) {
        this.spooky.run();
        callback();
    });

    this.Then('run spooky', function (callback) {
        var world = this;

        this.spooky.then(function () {
            this.emit('tests.complete', this.test.testResults);
        });

        this.spooky.once('tests.complete', (function (results) {
            this.unlisten();
            if (results.failed) {
                callback.fail(results.failures.map(function (failure) {
                    return 'Failed: ' + failure.message;
                }).join('\n'));
            } else {
                callback();
            }
        }).bind(this));

        this.spooky.run();
    });
};
